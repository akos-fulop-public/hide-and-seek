<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Vienna Game Map</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

	<style>
		html,
		body {
			margin: 0;
			padding: 0;
			height: 100%;
		}

		#map {
			width: 100%;
			height: 100%;
		}

		#menu-container {
			position: absolute;
			bottom: 10px;
			right: 10px;
			background: white;
			border-radius: 4px;
			box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
			width: max-content;
			font-family: sans-serif;
		}

		#menu-toggle {
			display: block;
			background: none;
			border: none;
			padding: 6px 12px;
			cursor: pointer;
			font-weight: bold;
		}

		#menu-content {
			display: none;
			/* initially hidden */
			flex-direction: column;
			gap: 4px;
			padding: 4px 12px;
		}

		#menu-content label {
			white-space: nowrap;
		}

		#menu {
			font-family: sans-serif;
			font-size: 14px;
		}

		.group {
			margin-bottom: 8px;
		}

		.sub {
			margin-left: 18px;
			opacity: 0.6;
			pointer-events: none;
		}

		.sub.enabled {
			opacity: 1;
			pointer-events: auto;
		}
	</style>
</head>

<body>

	<div id="map"></div>
	<div id="menu-container">
		<button id="menu-toggle">Layers ▼</button>
		<div id="menu-content">
			<div id="menu">

				<div class="group">
					<label><input type="checkbox" id="toggle-stations" checked> Stations </label>
					<div class="sub">
						<label> <input type="checkbox" id="toggle-station-labels"> Station labels </label>
					</div>
				</div>
				<div class="group">
					<label><input type="checkbox" id="toggle-zones">Show Hiding Zones</label>
				</div>
				<div class="group">
					<label> <input type="checkbox" id="toggle-museums"> Museums </label>
					<div class="sub">
						<label> <input type="checkbox" id="toggle-museum-labels"> Museum labels </label>
					</div>
				</div>
				<div class="group">
					<label> <input type="checkbox" id="toggle-embassies"> Embassies </label>
					<div class="sub">
						<label> <input type="checkbox" id="toggle-embassy-labels"> Embassy labels </label>
					</div>
				</div>

			</div>
		</div>
	</div>

	<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

	<script>
		const map = new maplibregl.Map({
			container: 'map',
			style: 'style.json',
			minZoom: 10,
			maxZoom: 16
		});
		function extendBounds(bounds, geometry) {
			if (geometry.type === 'Polygon') {
				geometry.coordinates.forEach(ring => ring.forEach(coord => bounds.extend(coord)));
			} else if (geometry.type === 'MultiPolygon') {
				geometry.coordinates.forEach(polygon => {
					polygon.forEach(ring => ring.forEach(coord => bounds.extend(coord)));
				});
			}
		}

		function padBounds(bounds, factor = 0.05) {
			const sw = bounds.getSouthWest();
			const ne = bounds.getNorthEast();

			const latPad = (ne.lat - sw.lat) * factor;
			const lngPad = (ne.lng - sw.lng) * factor;

			return new maplibregl.LngLatBounds(
				[sw.lng - lngPad, sw.lat - latPad],
				[ne.lng + lngPad, ne.lat + latPad]
			);
		}

		function setLayerVisibility(layerIds, visible) {
			layerIds.forEach(id => {
				if (map.getLayer(id)) {
					map.setLayoutProperty(
						id,
						"visibility",
						visible ? "visible" : "none"
					);
				}
			});
		}

		const STATION_LAYERS = ["stations", "lines"];
		const STATION_LABEL_LAYERS = ["station-labels"];
		const ZONE_LAYERS = ["hiding-zones"];
		const MUSEUM_LAYERS = ["museums-icon"];
		const MUSEUM_LABEL_LAYERS = ["museums-text"];
		const EMBASSY_LAYERS = ["embassy-icon"];
		const EMBASSY_LABEL_LAYERS = ["embassy-text"];

		fetch('data/districts.geojson')
			.then(res => res.json())
			.then(geojson => {
				const bounds = new maplibregl.LngLatBounds();
				geojson.features.forEach(feature => extendBounds(bounds, feature.geometry));

				// Apply padding to maxBounds
				map.setMaxBounds(padBounds(bounds, 0.2));

				map.addControl(new maplibregl.NavigationControl());

				map.on('load', () => {
					map.fitBounds(bounds, { padding: 40 });

					map.loadImage("./data/museum.png", (error, image) => {
						if (error) throw error;

						if (!map.hasImage("museum-icon")) {
							map.addImage("museum-icon", image, {
								sdf: false
							});
						}
					});

					map.loadImage("./data/embassy.png", (error, image) => {
						if (error) throw error;

						if (!map.hasImage("embassy-icon")) {
							map.addImage("embassy-icon", image, {
								sdf: false
							});
						}
					});

					map.addLayer({
						id: "museums-icon",
						type: "symbol",
						source: "vienna-museums",
						layout: {
							"icon-image": "museum-icon",
							"icon-size": [
								"interpolate",
								["linear"],
								["zoom"],
								11, 0.5,
								15, 0.8,
								18, 1.2
							],
							"icon-allow-overlap": true,
							"icon-ignore-placement": true
						}
					});
					map.addLayer({
						id: "museums-text",
						type: "symbol",
						source: "vienna-museums",
						layout: {
							"text-field": ["get", "NAME"],
							"text-size": 10,
							"text-anchor": "left",
							"text-offset": [0.8, 0],
							"text-allow-overlap": false,
							"text-ignore-placement": false
						}
					});

					map.addLayer({
						id: "embassy-icon",
						type: "symbol",
						source: "vienna-embassies",
						layout: {
							"icon-image": "embassy-icon",
							"icon-size": [
								"interpolate",
								["linear"],
								["zoom"],
								11, 0.5,
								15, 0.8,
								18, 1.2
							],
							"icon-allow-overlap": true,
							"icon-ignore-placement": true
						}
					});
					map.addLayer({
						id: "embassy-text",
						type: "symbol",
						source: "vienna-embassies",
						layout: {
							"text-field": ["get", "NAME"],
							"text-size": 10,
							"text-anchor": "left",
							"text-offset": [0.8, 0],
							"text-allow-overlap": false,
							"text-ignore-placement": false
						}
					});
					const stationsCheckbox = document.getElementById("toggle-stations");
					const stationLabelsCheckbox = document.getElementById("toggle-station-labels");
					const stationSub = stationLabelsCheckbox.closest(".sub");

					stationsCheckbox.addEventListener("change", (e) => {
						const on = e.target.checked;
						setLayerVisibility(STATION_LAYERS, on);
						stationSub.classList.toggle("enabled", on);
						if (!on) {
							stationLabelsCheckbox.checked = false;
							setLayerVisibility(STATION_LABEL_LAYERS, false);
						}
					});
					stationLabelsCheckbox.addEventListener("change", (e) => {
						setLayerVisibility(STATION_LABEL_LAYERS, e.target.checked);
					});
					const zonesCheckbox = document.getElementById("toggle-zones");
					zonesCheckbox.addEventListener("change", (e) => {
						setLayerVisibility(ZONE_LAYERS, e.target.checked);
					});

					const museumsCheckbox = document.getElementById("toggle-museums");
					const museumLabelsCheckbox = document.getElementById("toggle-museum-labels");
					const museumSub = museumLabelsCheckbox.closest(".sub");

					museumsCheckbox.addEventListener("change", (e) => {
						const on = e.target.checked;
						setLayerVisibility(MUSEUM_LAYERS, on);
						museumSub.classList.toggle("enabled", on);

						if (!on) {
							museumLabelsCheckbox.checked = false;
							setLayerVisibility(MUSEUM_LABEL_LAYERS, false);
						}
					});

					museumLabelsCheckbox.addEventListener("change", (e) => {
						setLayerVisibility(MUSEUM_LABEL_LAYERS, e.target.checked);
					});

					const embassiesCheckbox = document.getElementById("toggle-embassies");
					const embassiesLabelsCheckbox = document.getElementById("toggle-embassy-labels");
					const embassiesSub = embassiesLabelsCheckbox.closest(".sub");
					embassiesCheckbox.addEventListener("change", (e) => {
						const on = e.target.checked;
						setLayerVisibility(EMBASSY_LAYERS, on);
						embassiesSub.classList.toggle("enabled", on);

						if (!on) {
							embassiesLabelsCheckbox.checked = false;
							setLayerVisibility(EMBASSY_LABEL_LAYERS, false);
						}
					});

					embassiesLabelsCheckbox.addEventListener("change", (e) => {
						setLayerVisibility(EMBASSY_LABEL_LAYERS, e.target.checked);
					});

					setLayerVisibility(STATION_LAYERS, true);
					setLayerVisibility(STATION_LABEL_LAYERS, false);
					stationSub.classList.add("enabled");

					setLayerVisibility(ZONE_LAYERS, false);
					setLayerVisibility(MUSEUM_LAYERS, false);
					setLayerVisibility(MUSEUM_LABEL_LAYERS, false);

					setLayerVisibility(EMBASSY_LAYERS, false);
					setLayerVisibility(EMBASSY_LABEL_LAYERS, false);

					const toggleButton = document.getElementById("menu-toggle");
					const menuContent = document.getElementById("menu-content");

					toggleButton.addEventListener("click", () => {
						if (menuContent.style.display === "flex") {
							menuContent.style.display = "none";
							toggleButton.textContent = "Layers ▼";
						} else {
							menuContent.style.display = "flex";
							toggleButton.textContent = "Layers ▲";
						}
					});
				});
			});

	</script>

</body>

</html>
