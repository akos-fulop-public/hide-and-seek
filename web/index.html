<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Vienna Game Map</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

	<style>
		html,
		body {
			margin: 0;
			padding: 0;
			height: 100%;
		}

		#map {
			width: 100%;
			height: 100%;
		}

		#menu-container {
			position: absolute;
			bottom: 10px;
			right: 10px;
			background: white;
			border-radius: 4px;
			box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
			width: max-content;
			font-family: sans-serif;
		}

		#menu-toggle {
			display: block;
			background: none;
			border: none;
			padding: 6px 12px;
			cursor: pointer;
			font-weight: bold;
		}

		#menu-content {
			display: none;
			/* initially hidden */
			flex-direction: column;
			gap: 4px;
			padding: 4px 12px;
		}

		#menu-content label {
			white-space: nowrap;
		}
	</style>
</head>

<body>

	<div id="map"></div>
	<div id="menu-container">
		<button id="menu-toggle">Layers ▼</button>
		<div id="menu-content">
			<label><input type="checkbox" id="toggle-transport" checked>Show Transport</label>
			<label><input type="checkbox" id="toggle-zones">Show Hiding Zones</label>
			<label><input type="checkbox" id="toggle-museums">Show Museums</label>
		</div>
	</div>

	<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

	<script>
		const map = new maplibregl.Map({
			container: 'map',
			style: 'style.json',
			minZoom: 10,
			maxZoom: 16
		});
		function extendBounds(bounds, geometry) {
			if (geometry.type === 'Polygon') {
				geometry.coordinates.forEach(ring => ring.forEach(coord => bounds.extend(coord)));
			} else if (geometry.type === 'MultiPolygon') {
				geometry.coordinates.forEach(polygon => {
					polygon.forEach(ring => ring.forEach(coord => bounds.extend(coord)));
				});
			}
		}

		function padBounds(bounds, factor = 0.05) {
			const sw = bounds.getSouthWest();
			const ne = bounds.getNorthEast();

			const latPad = (ne.lat - sw.lat) * factor;
			const lngPad = (ne.lng - sw.lng) * factor;

			return new maplibregl.LngLatBounds(
				[sw.lng - lngPad, sw.lat - latPad],
				[ne.lng + lngPad, ne.lat + latPad]
			);
		}

		function setLayerVisibility(layerIds, visible) {
			layerIds.forEach(id => {
				if (map.getLayer(id)) {
					map.setLayoutProperty(
						id,
						"visibility",
						visible ? "visible" : "none"
					);
				}
			});
		}
		const transportLayers = ["lines", "stations"];
		const museumLayers = ["museums-icon", "museums-text"];
		const zoneLayers = ["hiding-zones"];

		fetch('data/districts.geojson')
			.then(res => res.json())
			.then(geojson => {
				const bounds = new maplibregl.LngLatBounds();
				geojson.features.forEach(feature => extendBounds(bounds, feature.geometry));

				// Apply padding to maxBounds
				map.setMaxBounds(padBounds(bounds, 0.2));

				map.addControl(new maplibregl.NavigationControl());

				map.on('load', () => {
					map.fitBounds(bounds, { padding: 40 });

					map.loadImage("./data/museum.png", (error, image) => {
						if (error) throw error;

						if (!map.hasImage("museum-icon")) {
							map.addImage("museum-icon", image, {
								sdf: false
							});
						}
					});

					map.addLayer({
						id: "museums-icon",
						type: "symbol",
						source: "vienna-museums",
						layout: {
							"icon-image": "museum-icon",
							"icon-size": [
								"interpolate",
								["linear"],
								["zoom"],
								11, 0.5,
								15, 0.8,
								18, 1.2
							],
							"icon-allow-overlap": true,
							"icon-ignore-placement": true
						}
					});
					map.addLayer({
						id: "museums-text",
						type: "symbol",
						source: "vienna-museums",
						layout: {
							"text-field": ["get", "NAME"],
							"text-size": 10,
							"text-anchor": "left",
							"text-offset": [0.8, 0],
							"text-allow-overlap": false,
							"text-ignore-placement": false
						}
					});

					setLayerVisibility(transportLayers, true);
					setLayerVisibility(museumLayers, false);
					setLayerVisibility(zoneLayers, false);

					document.getElementById("toggle-transport")
						.addEventListener("change", (e) => {
							setLayerVisibility(transportLayers, e.target.checked);
						});

					document.getElementById("toggle-museums")
						.addEventListener("change", (e) => {
							setLayerVisibility(museumLayers, e.target.checked);
						});
					document.getElementById("toggle-zones")
						.addEventListener("change", (e) => {
							setLayerVisibility(zoneLayers, e.target.checked);
						});

					const toggleButton = document.getElementById("menu-toggle");
					const menuContent = document.getElementById("menu-content");

					toggleButton.addEventListener("click", () => {
						if (menuContent.style.display === "flex") {
							menuContent.style.display = "none";
							toggleButton.textContent = "Layers ▼";
						} else {
							menuContent.style.display = "flex";
							toggleButton.textContent = "Layers ▲";
						}
					});
				});
			});

	</script>

</body>

</html>
